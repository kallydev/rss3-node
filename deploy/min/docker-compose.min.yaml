version: "3"

services:
  rss3_node_redis:
    restart: always
    image: redis:7-alpine
    networks:
      - default
    ports:
      - "6379:6379"
    volumes:
      - redis:/data

  rss3_node_database:
    restart: always
    image: postgres:16
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    networks:
      - default
    ports:
      - "8080:8080"
      - "5432:5432"
    volumes:
      - "postgres:/postgres/postgres-data"

  broadcaster:
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    ports:
      - "80"
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    environment:
      NODE_DISCOVERY_OPERATOR_EVM_ADDRESS: "[evm_address]"
      NODE_DISCOVERY_OPERATOR_SIGNATURE: "[signature_address]"
      NODE_DISCOVERY_SERVER_ENDPOINT: "[public_endpoint]"
      NODE_DISCOVERY_SERVER_GLOBAL_INDEXER_ENDPOINT: "https://gi.rss3.io"
    command: [ "./node", "--module=broadcaster" ]

  core:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    entrypoint: [ "./node", "--module", "core" ]

  monitor:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    environment:
      - NODE_ENV=production
      - WORKER_ID=monitor
    entrypoint: [ "./node", "--module", "monitor" ]

  ethereum-core:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    entrypoint: [ "./node", "--worker.id=ethereum-core" ]

  polygon-lens:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    entrypoint: [ "./node", "--worker.id=polygon-lens" ]

  farcaster-core:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    entrypoint: [ "./node", "--worker.id=farcaster-core" ]

  arweave-mirror:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    entrypoint: [ "./node", "--worker.id=arweave-mirror" ]

  arweave-momoka:
    restart: always
    image: ghcr.io/rss3-network/node:v1.0.0
    networks:
      - default
    volumes:
      - ./config.min.yaml:/etc/rss3/node/config.yaml
    depends_on:
      - rss3_node_database
      - rss3_node_redis
    entrypoint: [ "./node", "--worker.id=arweave-momoka" ]

volumes:
  postgres:
  redis:


networks:
  default:
